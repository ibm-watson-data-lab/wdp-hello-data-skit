  <!DOCTYPE html>
  <html>
    <head>
      <title>Watson Data Platform - Hello Data!</title>
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css" media="screen,projection">
      <link type="text/css" rel="stylesheet" href="css/spinner.css">

      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>

    <body>
      <div class="container" style="padding-top: 50px">
        <div class="row">
	      <div class="col s12">
	      	This application illustrates how to use the Watson Data Platform core API to access data assets, such as data files and connections. To start, enter your IBM Cloud API key. If you don't have one yet, <a href="https://console.bluemix.net/docs/iam/userid_keys.html#userapikey">follow these instructions to obtain one</a>.
	      </div>
	    </div>

        <div class="row">
	     <form class="col s12">
	      <div class="row valign-wrapper">
	        <div class="input-field col s8">
	          <input placeholder="API key" id="api_key" type="text" class="validate">
	          <label for="api_key">IBM Cloud API key</label>
	        </div>
	        <div class="col s4">	        	
	          <a class="waves-effect waves-light btn disabled" id="refresh_projects">Get projects</a>
	        </div>
	      </div>

	      <div class="row">
	        <div class="input-field col s12">
			    <select id = "projects" disabled>
			      <option value="" disabled selected>Enter an API key to display projects</option>
			    </select>
			    <label>Project</label>
	        </div>
	      </div>

	      <div class="row">
	        <div class="input-field col s12">
			    <select id = "assets" disabled>
			      <option value="" disabled selected>Choose a project to display its assets</option>
			    </select>
			    <label>Asset</label>
	        </div>
	      </div>

	      <div class="row">
	      	<div class = "col s12">
	      		<a class="waves-effect waves-light btn disabled" id = "go">Access asset</a>
	      	</div>
	      </div>
	    </form>
      </div>

	  <!-- Modal Structures -->
	  <div id="modal1" class="modal modal-fixed-footer">
	    <div class="modal-content" id="data_preview">
	    </div>
	    <div class="modal-footer">
	      <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat ">Close</a>
	    </div>
	  </div>

	  <div class="row" id="loading" style="display:none;">
	  		<div class="col s12">
				<div class="sk-fading-circle">
				  <div class="sk-circle1 sk-circle"></div>
				  <div class="sk-circle2 sk-circle"></div>
				  <div class="sk-circle3 sk-circle"></div>
				  <div class="sk-circle4 sk-circle"></div>
				  <div class="sk-circle5 sk-circle"></div>
				  <div class="sk-circle6 sk-circle"></div>
				  <div class="sk-circle7 sk-circle"></div>
				  <div class="sk-circle8 sk-circle"></div>
				  <div class="sk-circle9 sk-circle"></div>
				  <div class="sk-circle10 sk-circle"></div>
				  <div class="sk-circle11 sk-circle"></div>
				  <div class="sk-circle12 sk-circle"></div>
				</div>
	  		</div>
	  </div>

      <!-- API input and response -->
        <div class="row">
		    <form class="col s12">
		      <div class="row">
		      	<div class="col s12">
		      		Watson Data Platform API call
		      	</div>
		      </div>
		      <div class="row">
		        <div class="input-field col s12">
		          <textarea id="api_call_input" class="materialize-textarea" disabled></textarea>
		        </div>
		      </div>
		      <div class="row">
		      	<div class="col s4">
		      		HTTP response
		      	</div>
		     	<div class="col s8" id="http_status_output">
		      	</div> 	
		      </div>
		      <div class="row">
		      	<div class="col s12">
		      		API response
		      	</div>
		      </div>
		      <div class="row">
		        <div class="input-field col s12">
		          <textarea id="api_call_output" class="materialize-textarea" disabled ></textarea>
		        </div>
		      </div>		      
		    </form>
  		</div>
     </div>
      <!--Import jQuery before materialize.js-->
      <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>
      <script>

      	  function callBackend(opts, callback) {

      	  	function postProcess(jqxhr, callback) {
      	  		console.log('Processing backend response ...');
      	  		if(jqxhr.status == 200) {
      	  			//
      	  			console.log('Hello-data response: ' + jqxhr.responseText);
      	  			var payload = JSON.parse(jqxhr.responseText);

      	  			if(payload.response_type === 'api_response') {
	      	  			var response = {
	      	  				type: payload.response_type,
	      	  				API_call: payload.API_method + ' ' + payload.API_endpoint,
	      	  				API_HTTP_status: payload.API_HTTP_status,
	      	  				API_response_text: JSON.stringify(payload.API_response_text),
	      	  				json_object: payload
	      	  			}
      	  			   return callback(null, response);
      	  			}
      	  			else if(payload.response_type === 'data_response') {
	      	  			var response = {
	      	  				type: payload.response_type,
	      	  				payload: payload
	      	  			}
      	  			   return callback(null, response);
      	  			}
      	  			else {
      	  				// unkown response type
      	  				return callback(jqxhr);	
      	  			}
      	  		}
      	  		else {
      	  			// treat hello-data HTTP status codes other than 200 as errors
      	  			// sample  error jqxhr: {"readyState":4,"responseText":"Bluemix API key is missing","status":400,"statusText":"Bad Request"}
      	  			return callback(jqxhr);	
      	  		}
      	  		
      	  	};

      	  	var jqxhr = $.get({url: opts.url + '?' + $.param(opts.query_params)})
      	  	             .always(function() {
							console.log('Received response from backend');
							postProcess(jqxhr, callback);
      	  	             });
      	  };	


          function getProjectList(api_key, callback) {
           	const url = '/hello_data/listprojects';
          	console.log('Sending request to ' + url);         	
          	callBackend({url: url, 
          		         query_params: { 
          		         	api_key: api_key}},
          		         function(err, response) {
          		         	if(err) {
          		         		// the hello-data backend encountered a problem
          		         		return callback(err);
          		         	}

          		         	return callback(null, 
          		         		            response.json_object.project_list, 
          		         		            response.API_call, 
          		         					response.API_response_text, 
          		         					response.API_HTTP_status);
          		         });
          }

          function getAssetList(api_key, project_guid, callback) {
          	const url = '/hello_data/listassets/' + project_guid;
          	console.log('Sending request to ' + url);
          	callBackend({url: url,
          	             query_params: { 
          		         	api_key: api_key
          		         }},
          		         function(err, response) {
          		         	if(err) {
          		         		// the hello-data backend encountered a problem
          		         		return callback(err);
          		         	}

          		         	return callback(null, 
          		         		            response.json_object.asset_list || [], 
          		         		            response.API_call, 
          		         					response.API_response_text, 
          		         					response.API_HTTP_status);
          		         });
          }


          function accessAssetData(api_key, project_guid, asset_type, asset_id, callback) {

          	const url = '/hello_data/access_asset_data/' + asset_type + '/' + asset_id;
          	console.log('Sending request to ' + url);
          	callBackend({url: url,
          	             query_params: { 
          		         	api_key: api_key,
          		         	project_guid: project_guid
          		         }},
          		         function(err, response) {
          		         	if(err) {
          		         		// the hello-data backend encountered a problem
          		         		return callback(err);
          		         	}

          		         	return callback(null, 
          		         		            response);
          		         });
          }


          function updateAPIDisplay(api_input, api_output, http_status) {
   			// update API input display
   	  		$('#api_call_input').val(api_input);
			$('#api_call_input').trigger('autoresize');

			if(http_status) {
				console.log(JSON.stringify(http_status));
				$('#http_status_output').html(http_status.code + ' (' + http_status.text + ')');
			}
			else {
				$('#http_status_output').html('');
			}

			// update API output display
   	  		$('#api_call_output').val(api_output);
			$('#api_call_output').trigger('autoresize');
          };


          function clearAPIDisplay() {
          	updateAPIDisplay('','',null);
          }

          function displayHelloDataError(jqxhr) {
          	clearAPIDisplay();
          	alert('The hello_data backend encountered an error. HTTP status code ' + jqxhr.status + ' (' + jqxhr.statusText + '): ' + jqxhr.responseText);
          }

          function disableAllInput() {
          	// disable all buttons
			$('#refresh_projects').addClass('disabled');
			$('#go').addClass('disabled');
			// disable all selects
			$('#projects').prop('disabled', true);	
            $('#projects').material_select(); 
			$('#assets').prop('disabled', true);	
            $('#assets').material_select();
            //disable all inputs
            $('#api_key').prop('disabled', true);
          }

          function enableAllInput() {
          	// enable all buttons
			$('#refresh_projects').removeClass('disabled');
			$('#go').removeClass('disabled');
			// enable all selects
			$('#projects').prop('disabled', false);	
            $('#projects').material_select(); 
			$('#assets').prop('disabled', false);	
            $('#assets').material_select();
            //enable all inputs
            $('#api_key').prop('disabled', false);
          }

          function initializeProjectSelectionList(text) {
			// clear project selection list
			$('#projects').children().remove();
			$('#projects').append($('<option></option>')
				                   .attr('value', '')
			    	               .text(text)
		            	         );	
	    	// disable project select input
			$('#projects').prop('disabled', true);	
			$('#projects').material_select();
          }

          function initializeAssetSelectionList(text) {
			// clear asset selection list
			$('#assets').children().remove();
			$('#assets').append($('<option></option>')
				                   .attr('value', '')
			    	               .text(text)
		            	         );	
	    	// disable assets select input
			$('#assets').prop('disabled', true);	
			$('#assets').material_select();	
          }


      	  $(document).ready(function() {

    		$('select').material_select();

			// an API key was entered or updated
			$('#api_key').keyup(function() {
				if($('#api_key').val().trim().length > 0) {
					// enable project refresh button
					$('#refresh_projects').removeClass('disabled');
				}
				else {
					$('#refresh_projects').addClass('disabled');
			    }
			    initializeProjectSelectionList('Enter an API key to display projects');
				initializeAssetSelectionList('Choose a project to display its assets');			
		    });

			$('#api_key').on('paste', 
				             function() {
				setTimeout(function() {
					if($('#api_key').val().trim().length > 0) {
						// enable project refresh button
						$('#refresh_projects').removeClass('disabled');
					}
					else {
						$('#refresh_projects').addClass('disabled');
					}
			    	initializeProjectSelectionList('Enter an API key to display projects');
					initializeAssetSelectionList('Choose a project to display its assets');		
				}, 100);
			});

			// user has provided an API key and wants to retrieve project list
			$('#refresh_projects').click(function()
			{
			    initializeProjectSelectionList('Enter an API key to display projects');
				initializeAssetSelectionList('Choose a project to display its assets');		

				disableAllInput();

				clearAPIDisplay();

				if($('#api_key').val().trim().length === 0) {
					return;
				}

                $('#loading').show();
				// call getprojects endpoint
				console.log('Getting project list using API key ' + $('#api_key').val());
				getProjectList($('#api_key').val(), 
					           function(err, project_list, api_input, api_output, http_status){
					           	    $('#loading').hide();
					           	    $('#refresh_projects').removeClass('disabled');
					           	    $('#api_key').prop('disabled', false);
					           		if(err) {
					           			displayHelloDataError(err);
					           		}
					           		else {
										updateAPIDisplay(api_input, api_output, http_status);

            							// clear project selection list
            							$('#projects').children().remove();
            							//  add options to project selection list
            							if(project_list.length == 0) {  
            						    	initializeProjectSelectionList('No projects were found');				
            							}
            							else {
            								$('#projects').append($('<option></option>')
	            									                   .attr('value', '')
	            									                   .text('Select a project')
	            									                   .prop('selected', true)
	            									                   .prop('disabled', true)
	            								                      );	
	            							$.each(project_list, function(index, project_info) {
	            								console.log(project_info.name + ' ' + project_info.guid);
	            								$('#projects').append($('<option></option>')
	            									                   .attr('value', project_info.guid)
	            									                   .text(project_info.name)
	            								                      );	
	            							});
	            							// enable project select input
            								$('#projects').prop('disabled', false);	
            							}
            							$('#projects').material_select();            						
					           		}
					           });
			});

			// a project was selected
			$('#projects').change(function() {

				initializeAssetSelectionList('Choose a project to display its assets');	
				disableAllInput();
				clearAPIDisplay();

				$('#loading').show();
				// refresh project asset list 
				console.log('Getting asset list for project id ' + $('#projects').val());
				getAssetList($('#api_key').val(),
					         $('#projects').val(), 
					           function(err, asset_list, api_input, api_output, http_status){
								    $('#loading').hide();
								    $('#refresh_projects').removeClass('disabled');
								    $('#projects').prop('disabled', false);	
            						$('#projects').material_select(); 
            						$('#api_key').prop('disabled', false);
					           		if(err) {
					           			displayHelloDataError(err);
					           		}
					           		else {
										updateAPIDisplay(api_input, api_output, http_status);

            							// clear asset selection list
            							$('#assets').children().remove();
            							//  add options to project selection list
            							if(asset_list.length == 0) {
            								var asset_selector_text = 'Project does not contain data assets.';
            								if(http_status.code > 200) {
            									asset_selector_text = 'Asset list is unavailable.'
            								} 
											initializeAssetSelectionList(asset_selector_text);           							
            							}
            							else {
            								$('#assets').append($('<option></option>')
	            									                   .attr('value', '')
	            									                   .text('Select an asset')
	            									                   .prop('selected', true)
	            									                   .prop('disabled', true)
	            								                      );	
	            							$.each(asset_list, function(index, asset_info) {
	            								console.log(asset_info.name + ' ' + asset_info.guid + ' ' + asset_info.type);
	            								$('#assets').append($('<option></option>')
	            									                   .attr('value', asset_info.type + ':' + asset_info.guid)
	            									                   .text(asset_info.name)
	            								                      );	
	            							});
	            							// enable asset select input
            								$('#assets').prop('disabled', false);	
            							}

            							$('#assets').material_select();
            						
					           		}
					           });

			});


			$('#assets').change(function() {
				clearAPIDisplay();
				console.log('The selected asset is ' + $('#assets').val() + '. Asset action is enabled.');
				// an asset was selected; enable button
            	$('#go').removeClass('disabled');	
			});

			$('#go').click(function() {
				clearAPIDisplay();
				disableAllInput();
				$('#loading').show();
            	// call hello_data backend to fetch asset data
				accessAssetData($('#api_key').val(),$('#projects').val(),$('#assets').val().split(':')[0],$('#assets').val().split(':')[1],
					            function(err, response) {
					            	    $('#loading').hide();
					            	    enableAllInput();
					            		var html = null;
					            		if(err) {
					            			console.log(JSON.stringify(err));
					            			if(err.status === 501) {
							            	    html = '<h4>Data access failed</h4>' +
					            			            '<table>' + 
					            			            '<tr><th>Asset type</th><td>' + err.responseJSON.asset_type + '</td>' + '</tr>' +
					            			            '<tr><th>Sub type</th><td>' + err.responseJSON.asset_sub_type_label + '</td>' + '</tr>' +
					            			            '<tr><th>Reason</th><td>' + err.responseJSON.reasonMessage + '</td>' + '</tr>' +
					            			            '</table>';
					            			}
					            			else {
					            				html = '<h4>Error</h4>' +
					            				       '<p>' + err.responseText + '</p>';
					            			}
					            			$('#data_preview').html(html);
											$('#modal1').openModal();	
					            		}
					            		else {
					            			html = '<h4>Data access was successful</h4>' +
					            		           '<table>' + 
					            			       '<tr><th>Asset type</th><td>' + response.payload.asset_type + '</td>' + '</tr>' +
					            	               '<tr><th>Sub type</th><td>' + response.payload.asset_sub_type_label + '</td>' + '</tr>' +
					               	               '<tr><th>Asset info</th><td>' + response.payload.data + '</td>' + '</tr>' +
					            			       '</table>';
					            			$('#data_preview').html(html);
											$('#modal1').openModal();		            			
					            		}
					            });


			});

            console.log('hello-data is ready');
  	  	   });

      </script>
  
    </body>
  </html>